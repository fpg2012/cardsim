# 脚本接口

## 概述

脚本是客户端在运行时动态加载的、由用户编写的文本代码。引入脚本的目的是便于自定义客户端的行为。例如：略

为了方便调用，使用lua语言编写。脚本和客户端之间的交互使用函数互调来实现。具体来说，**客户端与脚本实现约定一系列事件和回调函数名，客户端在特定事件发生时，调用脚本中特定名字的的回调函数**。例如，在客户端移动组件后，调用脚本的`on_moved`函数，将组件和事件相关信息传给脚本，脚本对组件进行更新，把更新后的组件传回给客户端。

客户端也提供给脚本一系列可调用的函数，以便脚本改变组件的状态。

事件大致可以分成3类：

1. 服务器传来的事件：用户加入、用户退出、来自服务器的状态更新等

2. 内置组件的内置事件：移动、旋转、抽卡等，不同内置组件可能有不同的事件

3. 脚本自定义的事件

在本文中，前两类事件统称为内置事件，脚本自定义的事件简称自定义事件。

第三类事件其实是对第二类事件的扩展。

脚本可在其全局变量`custom_events`表中，记录事件名和对应的回调函数名。客户端会叫事件名添加到程序的菜单中，对应的菜单选项触发时，客户端会查此表，然后调用表中的回调函数。

脚本还可在组件的JSON中添加`custom_events`表项，结构和全局变量的表类似。当组件被选中时，客户端的菜单中除了显示组件的内置事件，还会显示该表的自定义事件。

### 客户端加载和调用脚本的过程

在用户选择对应脚本包后，客户端会加载包中资源，然后加载脚本。

脚本包加载后，脚本会先被客户端执行一遍。然后客户端会读取脚本的全局变量`custom_events`表，以便显示菜单。

特定事件触发时

## 脚本包结构

> TODO. 本节内容尚待确定

脚本包是整合脚本及其所需的资源的一个文件夹或压缩包。资源主要指材质和声音等内置组件显示需要引用的内容。

TODO

## 自定义事件表

### 全局

全局`custom_events`表结构大致如下：

```lua
custom_events = {
    event_name = on_event_callback,
    event_name2 = on_event2_callback
}
```

回调函数没有参数。

### 组件

组件的`custom_event`表定义在组件的JSON中，大致如下

```json
"custom_events": {
    "event_name": "on_event_callback_name",
    "event_name2": "on_event_callback_name2",
    "flip": "on_mycard_flipped"
}
```

回调函数包括两个参数

1. 组件的`component_id_`，是个32位整数

2. 组件对应的JSON（传给lua变成lua中的表）

## 内置事件和对应回调函数

> TODO. 本节内容尚待确定

| 事件名         | 回调函数名                 | 回调函数参数         | 分类     | 备注                                 |
| ----------- | --------------------- | -------------- | ------ | ---------------------------------- |
| `join`      | `on_server_join`      | user_profile   | 1      | 服务器其他用户加入                          |
| `self_join` | `on_server_self_join` | user_list      | 1      | 客户端成功连接服务器                         |
| `quit`      | `on_server_quit`      | user_profile   | 1      | 服务器其他用户退出                          |
| `operate`   | `on_server_operate`   | ops            | 1      | 服务器发来operate事件，ops的内容参见protocol.md |
| `move`      | `on_component_move`   | component      | 2      | 移动完成                               |
| `draw_card` | `on_deck_draw_card`   | deck, new_card | 2-deck | Deck发生抽卡                           |

## 提供给脚本的接口

> TODO. 本节内容尚待确定

| 函数名                 | 参数            | 备注                        |
| ------------------- | ------------- | ------------------------- |
| `si_get_game_state` |               | 获取游戏状态，包括在线用户和桌面组件        |
| `si_get_component`  | component_id_ | 获取组件                      |
| `si_operate`        | ops           | 改变组件状态，ops内容参见protocol.md |


